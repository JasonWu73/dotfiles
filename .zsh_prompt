#!/usr/bin/env zsh

##
# ç»ˆç«¯å‘½ä»¤æç¤ºç¬¦
##

# Git ç‰ˆæœ¬æ§åˆ¶ä¿¡æ¯ï¼Œå˜é‡ `vcs_info_msg_0_`
autoload -Uz vcs_info
zstyle ':vcs_info:*' enable git
# æ ¼å¼åŒ–é€šç”¨è¾“å‡º
 zstyle ':vcs_info:git:*' formats '%F{7}on%f %F{046}%b%f' # dark
#zstyle ':vcs_info:git:*' formats '%F{000}on%f %F{034}%b%f' # light
# æ ¼å¼åŒ– merge æˆ– rebase æ—¶è¾“å‡º
 zstyle ':vcs_info:git*' actionformats '%F{7}on [%f%F{046}%b%f%F{7}|%f%F{196}%a%f%F{7}]%f' # dark
#zstyle ':vcs_info:git*' actionformats '%F{000}on [%f%F{034}%b%f%F{000}|%f%F{196}%a%f%F{000}]%f' # light

# æŒ‚é’©å‡½æ•°ï¼Œåœ¨æ¯æ¬¡ç»ˆç«¯æç¤ºå‰æ‰§è¡Œ
precmd() {
  vcs_info

  # è®¾ç½®ç»ˆç«¯çª—å£æ ‡é¢˜
  print -n '\e]2;å´ä»™æ° ğŸ–\a'
}

# å…è®¸åœ¨ç»ˆç«¯æç¤ºç¬¦ä¸­æ›¿æ¢å†…å®¹
setopt prompt_subst

# ä»¥ root èº«ä»½ç™»å½•æ—¶çªå‡ºæ˜¾ç¤ºç”¨æˆ·å
if [[ "${USER}" == "root" ]]; then
  username="%F{196}%n%f"
  prompt_sign='#'
else
   username="%F{208}%n%f" # dark
#  username="%F{166}%n%f" # right
  prompt_sign='$'
fi

# é€šè¿‡ SSH è¿æ¥æ—¶çªå‡ºæ˜¾ç¤ºä¸»æœºå
if [[ "${SSH_TTY}" ]]; then
  hostname="%F{196}%m%f"
else
   hostname="%F{226}%m%f" # dark
#  hostname="%F{208}%m%f" # light
fi

# é»˜è®¤äº¤äº’å¼æç¤ºç¬¦
# æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»æ˜¯å•å¼•å·
# shellcheck disable=SC2154
# dark
 PS1='${username} %F{7}at%f ${hostname} %F{7}in %F{4}%~%f ${vcs_info_msg_0_}
 %F{7}${prompt_sign}%f '
# light
#PS1='${username} %F{000}at%f ${hostname} %F{000}in %F{039}%~%f ${vcs_info_msg_0_}
#%F{000}${prompt_sign}%f '
export PS1

# å»¶ç»­äº¤äº’å¼æç¤ºç¬¦
PS2="%F{226}â†’%f "
export PS2

##
# è‡ªåŠ¨è¡¥å…¨é…ç½®
##

# å¯ç”¨åŒ…æ‹¬ ssh/scp/sftp ä¸»æœºåçš„è‡ªåŠ¨è¡¥å…¨
autoload -Uz compinit
compinit

# æ•²å‡»ä¸¤ä¸‹ tab é”®æ¿€æ´»é€‰æ‹©èœå•
zstyle ':completion:*' menu select

# åˆ«åè‡ªåŠ¨è¡¥å…¨
setopt COMPLETE_ALIASES

# è‡ªåŠ¨è¡¥å…¨å¿½ç•¥å­—æ¯å¤§å°å†™
zstyle ':completion:*' matcher-list '' 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'

# åŠ è½½ zsh/complist æ¨¡å—ï¼Œç”¨äºå¯¹æ’ä»¶åˆ—è¡¨çš„è¡¥å…¨
zmodload zsh/complist

# æ— éœ€ . å°±å¯ä»¥æ˜¾ç¤ºéšè—æ–‡ä»¶åŠæ–‡ä»¶å¤¹
setopt GLOBDOTS

# ç»‘å®š Vi å¯¼èˆªé”®
bindkey -M menuselect 'h' vi-backward-char
bindkey -M menuselect 'k' vi-up-line-or-history
bindkey -M menuselect 'l' vi-forward-char
bindkey -M menuselect 'j' vi-down-line-or-history

##
# é…ç½®å‘½ä»¤è¡Œ Vi ç¼–è¾‘æ¨¡å¼
##

# è®¾ç½® zsh çš„è¡Œç¼–è¾‘å™¨ï¼ˆZsh Line Editorï¼ŒZLEï¼‰ä½¿ç”¨ vi æ¨¡å¼
bindkey -v
# æ¶ˆé™¤ vi å’Œ zsh ä¸­ esc çš„å»¶è¿Ÿ
export KEYTIMEOUT=1
# ä¿®å¤ backspace é”®åœ¨åˆ‡æ¢ vi æ¨¡å¼åæ— æ³•åˆ é™¤å­—ç¬¦çš„ bug
bindkey '^?' backward-delete-char

# åœ¨ä¸åŒçš„ vi æ¨¡å¼ä¸‹æ”¹å˜å…‰æ ‡å½¢çŠ¶
vi_mode_cursor() {
  case $KEYMAP in
  vicmd) print -n '\033[1 q' ;; # block cursor
  viins | main) print -n '\033[5 q' ;; # line cursor
  esac
}
zle-keymap-select() {
  vi_mode_cursor
}
zle-line-init() {
  vi_mode_cursor
}
zle-line-finish() {
  vi_mode_cursor
}
zle -N zle-line-init
zle -N zle-line-finish
zle -N zle-keymap-select

# åœ¨ vi ç¼–è¾‘å™¨ä¸­ç¼–è¾‘å‘½ä»¤è¡Œ
autoload -Uz edit-command-line
zle -N edit-command-line

# ç»‘å®šå¿«æ·é”® ctrl-v è¿›å…¥ vi ç¼–è¾‘å™¨ï¼Œå³å¤šè¡Œç¼–è¾‘å‘½ä»¤è¡Œ
bindkey '^v' edit-command-line
